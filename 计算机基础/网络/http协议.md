### HTTP 历史

1. HTTP/0.9

20 世纪 90 年代初期的互联网世界非常简陋，计算机处理能力低，存储容量小，网速很慢，还是一片信息荒漠。网络上绝大多数的资源都是纯文本，很多通信协议也都使用纯文本，所以 HTTP 的设计也不可避免地受到了时代的限制

这一时期的 HTTP 被定义为 0.9 版，结构比较简单，为了便于服务器和客户端处理，它也采用了纯文本格式。蒂姆·伯纳斯 - 李最初设想的系统里的文档都是只读的，所以只允许用`GET`动作从服务器上获取 HTML 文档，并且在响应请求之后立即关闭连接，功能非常有限

2. HTTP/1.0

HTTP/1.0 版本在 1996 年正式发布。它在多方面增强了 0.9 版，形式上已经和我们现在的 HTTP 差别不大了，例如:
- 增加了 HEAD、POST 等新方法
- 增加了响应状态码，标记可能的错误原因
- 引入了协议版本号概念
- 引入了 HTTP Header（头部）的概念，让 HTTP 处理请求和响应更加灵活
- 传输的数据不再仅限于文本

但 HTTP/1.0 并不是一个标准，只是记录已有实践和模式的一份参考文档，不具有实际的约束力，相当于一个备忘录

3. HTTP/1.1

从版本号我们就可以看到，HTTP/1.1 是对 HTTP/1.0 的小幅度修正。但一个重要的区别是：它是一个正式的标准，而不是一份可有可无的参考文档。这意味着今后互联网上所有的浏览器、服务器、网关、代理等等，只要用到 HTTP 协议，就必须严格遵守这个标准，相当于是互联网世界的一个立法

HTTP/1.1 主要的变更点有:
- 增加了 PUT、DELETE 等新的方法
- 增加了缓存管理和控制
- 明确了连接管理，允许持久连接
- 允许响应数据分块（chunked），利于传输大文件
- 强制要求 Host 头，让互联网主机托管成为可能

HTTP/1.1 的推出可谓是众望所归，开启了后续的Web 1.0, Web 2.0时代

4. HTTP/2.0

HTTP/1.1 发布之后，整个互联网世界呈现出了爆发式的增长, 这期间也出现了一些对 HTTP 不满的意见，主要就是连接慢，无法跟上迅猛发展的互联网，但 HTTP/1.1 标准一直岿然不动，无奈之下人们只好发明各式各样的小花招来缓解这些问题，比如以前常见的切图、JS 合并等网页优化手段

Google 把 SPDY 推上了标准的宝座，互联网标准化组织以 SPDY 为基础开始制定新版本的 HTTP 协议，最终在 2015 年发布了 HTTP/2，RFC 编号 7540

HTTP/2 的制定充分考虑了现今互联网的现状：宽带、移动、不安全，在高度兼容 HTTP/1.1 的同时在性能改善方面做了很大努力，主要的特点有:
- 二进制协议，不再是纯文本
- 可发起多个请求，废弃了 1.1 里的管道
- 使用专用算法压缩头部，减少数据传输量
- 允许服务器主动向客户端推送数据
- 增强了安全性，事实上要求加密通信

虽然 HTTP/2 到今天已经四年了，也衍生出了 gRPC 等新协议，但由于 HTTP/1.1 实在是太过经典和强势，目前它的普及率还比较低，大多数网站使用的仍然还是 20 年前的 HTTP/1.1

5. HTTP/3

在 HTTP/2 还处于草案之时，Google 又发明了一个新的协议，叫做 QUIC，而且还是相同的套路，继续在 Chrome 和自家服务器里试验着玩，依托它的庞大用户量和数据量，持续地推动 QUIC 协议成为互联网上的既成事实

2018 年，互联网标准化组织 IETF 提议将`HTTP over QUIC`更名为`HTTP/3`并获得批准，HTTP/3 正式进入了标准化制订阶段，也许两三年后就会正式发布，到时候我们很可能会跳过 HTTP/2 直接进入 HTTP/3

### HTTP是什么

HTTP 就是超文本传输协议，也就是 HyperText Transfer Protocol

超文本传输协议:
- 超文本
- 传输
- 协议

HTTP 是一个用在计算机世界里的协议。它使用计算机能够理解的语言确立了一种计算机之间交流通信的规范，以及相关的各种控制和错误处理方式

计算机和网络世界里有数不清的各种角色：CPU、内存、总线、磁盘、操作系统、浏览器、网关、服务器……这些角色之间相互通信也必然会有各式各样、五花八门的协议，用处也各不相同，例如广播协议、寻址协议、路由协议、隧道协议、选举协议等等

HTTP 是一个传输协议，所谓的传输（Transfer）其实很好理解，就是把一堆东西从 A 点搬到 B 点，或者从 B 点搬到 A 点

HTTP 协议是一个双向协议，也就是说，有两个最基本的参与者 A 和 B，从 A 开始到 B 结束，数据在 A 和 B 之间双向而不是单向流动。通常我们把先发起传输动作的 A 叫做请求方，把后接到传输的 B 叫做应答方或者响应方

数据虽然是在 A 和 B 之间传输，但并没有限制只有 A 和 B 这两个角色，允许中间有中转或者接力，这样，传输方式就从`A<===>B`，变成了`A<=>X<=>Y<=>Z<=>B`，A 到 B 的传输过程中可以存在任意多个“中间人”，而这些中间人也都遵从 HTTP 协议，只要不打扰基本的数据传输，就可以添加任意的额外功能，例如安全认证、数据压缩、编码转换等等，优化整个传输过程

即**HTTP 是一个在计算机世界里专门用来在两点之间传输数据的约定和规范**

所谓文本（Text），就表示 HTTP 传输的不是 TCP/UDP 这些底层协议里被切分的杂乱无章的二进制包，而是完整的、有意义的数据，可以被浏览器、服务器这样的上层应用程序处理

在互联网早期，文本只是简单的字符文字，但发展到现在，文本的涵义已经被大大地扩展了，图片、音频、视频、甚至是压缩包，在 HTTP 眼里都可以算做是文本

所谓超文本，就是超越了普通文本的文本，它是文字、图片、音频和视频等的混合体，最关键的是含有超链接，能够从一个超文本跳跃到另一个超文本，形成复杂的非线性、网状的结构关系

对于超文本，我们最熟悉的就应该是 HTML 了，它本身只是纯文字文件，但内部用很多标签定义了对图片、音频、视频等的链接，再经过浏览器的解释，呈现在我们面前的就是一个含有多种视听信息的页面

**在互联网世界里，HTTP 通常跑在 TCP/IP 协议栈之上，依靠 IP 协议实现寻址和路由、TCP 协议实现可靠数据传输、DNS 协议实现域名查找、SSL/TLS 协议实现安全通信。此外，还有一些协议依赖于 HTTP，例如 WebSocket、HTTPDNS 等。这些协议相互交织，构成了一个协议网，而 HTTP 则处于中心地位**


### HTTP相关的各种概念

互联网的正式名称是 Internet，里面存储着无穷无尽的信息资源，我们通常所说的上网实际上访问的只是互联网的一个子集万维网（World Wide Web），它基于 HTTP 协议，传输 HTML 等超文本资源，能力也就被限制在 HTTP 协议之内。互联网上还有许多万维网之外的资源，例如常用的电子邮件、BT 和 Magnet 点对点下载、FTP 文件下载、SSH 安全登录、各种即时通信服务等等，它们需要用各自的专有协议来访问。不过由于 HTTP 协议非常灵活、易于扩展，而且超文本的表述能力很强，所以很多其他原本不属于 HTTP 的资源也可以“包装”成 HTTP 来访问，这就是我们为什么能够总看到各种“网页应用”——例如微信网页版,邮箱网页版的原因

#### 1.浏览器

上网就要用到浏览器，常见的浏览器有 Google 的 Chrome、Mozilla 的 Firefox、Apple 的 Safari、Microsoft 的 IE 和 Edge

浏览器本质上是一个 HTTP 协议中的请求方，使用 HTTP 协议获取网络上的各种资源。当然，为了让我们更好地检索查看网页，它还集成了很多额外的功能

在 HTTP 协议里，浏览器的角色被称为`User Agent`即用户代理，意思是作为访问者的代理来发起 HTTP 请求。不过在不引起混淆的情况下，我们通常都简单地称之为`客户端`

#### 2.Web 服务器

Web 服务器是一个很大也很重要的概念，它是 HTTP 协议里响应请求的主体，通常也把控着绝大多数的网络资源，在网络世界里处于强势地位

Nginx 是 Web 服务器里的后起之秀，特点是高性能、高稳定，且易于扩展。在高流量的网站里更是不二之选

#### 3.CDN

浏览器和服务器是 HTTP 协议的两个端点, 浏览器通常不会直接连到服务器，中间会经过重重关卡，其中的一个重要角色就叫做 CDN

CDN，全称是`Content Delivery Network`，翻译过来就是内容分发网络。它应用了 HTTP 协议里的缓存和代理技术，代替源站响应客户端的请求

它可以缓存源站的数据，让浏览器的请求不用千里迢迢地到达源站服务器，直接在半路就可以获取响应。如果 CDN 的调度算法很优秀，更可以找到离用户最近的节点，大幅度缩短响应时间

CDN 也是现在互联网中的一项重要基础设施，除了基本的网络加速外，还提供负载均衡、安全防护、边缘计算、跨运营商网络等功能，能够成倍地放大源站服务器的服务能力，很多云服务商都把 CDN 作为产品的一部分

#### 4.爬虫

但 HTTP 协议并没有规定用户代理后面必须是真正的人类，它也完全可以是机器人，这些机器人的正式名称就叫做爬虫（Crawler），实际上是一种可以自动访问 Web 资源的应用程序

爬虫也有不好的一面，它会过度消耗网络资源，占用服务器和带宽，影响网站对真实数据的分析，甚至导致敏感信息泄漏。所以，又出现了反爬虫技术，通过各种手段来限制爬虫。其中一项就是君子协定`robots.txt`，约定哪些该爬，哪些不该爬

无论是爬虫还是反爬虫，用到的基本技术都是两个，一个是 HTTP，另一个就是 HTML

#### 5.HTML

HTML 是 HTTP 协议传输的主要内容之一，它描述了超文本页面，用各种标签定义文字、图片等资源和排版布局，最终由浏览器渲染出可视化页面

#### 6.WAF

WAF 意思是网络应用防火墙。与硬件防火墙类似，它是应用层面的防火墙，专门检测 HTTP 流量，是防护 Web 应用的安全技术。WAF 通常位于 Web 服务器之前，可以阻止如 SQL 注入、跨站脚本等攻击，目前应用较多的一个开源项目是 ModSecurity，它能够完全集成进 Apache 或 Nginx

### 与HTTP相关的各种协议

#### 1.TCP/IP

TCP/IP 协议实际上是一系列网络通信协议的统称，其中最核心的两个协议是 TCP 和 IP，其他的还有 UDP、ICMP、ARP 等等，共同构成了一个复杂但有层次的协议栈

这个协议栈有四层，最上层是应用层，最下层是链接层，TCP 和 IP 则在中间：TCP 属于传输层，IP 属于网际层。协议的层级关系模型非常重要

- IP 协议是`Internet Protocol`的缩写，主要目的**是解决寻址和路由问题**，以及如何在两点间传送数据包。IP 协议使用“IP 地址”的概念来定位互联网上的每一台计算机
- TCP 协议是`Transmission Control Protocol`的缩写，意思是传输控制协议，它位于 IP 协议之上，基于 IP 协议提供可靠的、字节流形式的通信，是 HTTP 协议得以实现的基础

现在我们使用的 IP 协议大多数是 v4 版，地址是四个用`.`分隔的数字，例如`192.168.0.1`，总共有 `2^32`，大约 42 亿个可以分配的地址。看上去好像很多，但互联网的快速发展让地址的分配管理很快就捉襟见肘。所以，就又出现了 v6 版，使用 8 组`:`分隔的数字作为地址，容量扩大了很多，有 `2^128` 个，在未来的几十年里应该是足够用了

可靠是指保证数据不丢失，字节流是指保证数据完整，所以在 TCP 协议的两端可以如同操作文件一样访问传输的数据，就像是读写在一个密闭的管道里“流动”的字节

**HTTP 是一个传输协议，但它不关心寻址、路由、数据完整性等传输细节，而要求这些工作都由下层来处理。因为互联网上最流行的是 TCP/IP 协议，而它刚好满足 HTTP 的要求，所以互联网上的 HTTP 协议就运行在了 TCP/IP 上，HTTP 也就可以更准确地称为`HTTP over TCP/IP`**


#### 2.DNS

域名系统（Domain Name System）用有意义的名字来作为 IP 地址的等价替代

在 DNS 中，域名（Domain Name）又称为主机名（Host），为了更好地标记不同国家或组织的主机，让名字更好记，所以被设计成了一个有层次的结构

域名用`.`分隔成多个单词，级别从左到右逐级升高，最右边的被称为顶级域名。对于顶级域名，可能你随口就能说出几个，例如表示商业公司的`com`、表示教育机构的`edu`

但想要使用 TCP/IP 协议来通信仍然要使用 IP 地址，所以需要把域名做一个转换，映射到它的真实 IP，这就是所谓的**域名解析**

#### 3.URI/URL

DNS 和 IP 地址只是标记了互联网上的主机，但主机上有那么多文本、图片、页面，到底要找哪一个呢？

`URI`（Uniform Resource Identifier），中文名称是 **统一资源标识符**，使用它就能够唯一地标记互联网上资源

`URI` 另一个更常用的表现形式是 URL（Uniform Resource Locator）， **统一资源定位符**，也就是我们俗称的网址，它实际上是 URI 的一个子集，不过因为这两者几乎是相同的，差异不大，所以通常不会做严格的区分

URI 主要有三个基本的部分构成:
- 协议名：即访问该资源应当使用的协议，在这里是`http`
- 主机名：即互联网上主机的标记，可以是域名或 IP 地址，在这里是`nginx.org`
- 路径：即资源在主机上的位置，使用`/`分隔多级目录，在这里是`/en/download.html`


#### 4.HTTPS

HTTPS 它的全称是`HTTP over SSL/TLS`，也就是运行在 SSL/TLS 协议上的 HTTP, 这里是 SSL/TLS，而不是 TCP/IP，它是一个负责加密通信的安全协议，建立在 TCP/IP 之上，所以也是个可靠的传输协议，可以被用作 HTTP 的下层

HTTPS 相当于`HTTP+SSL/TLS+TCP/IP`

SSL 使用了许多密码学最先进的研究成果，综合了对称加密、非对称加密、摘要算法、数字签名、数字证书等技术，能够在不安全的环境中为通信的双方创建出一个秘密的、安全的传输通道，为 HTTP 套上一副坚固的盔甲


#### 5.代理

代理（Proxy）是 HTTP 协议中请求方和应答方中间的一个环节，作为中转站，既可以转发客户端的请求，也可以转发服务器的应答

- 匿名代理：完全隐匿了被代理的机器，外界看到的只是代理服务器
- 透明代理：顾名思义，它在传输过程中是透明开放的，外界既知道代理，也知道客户端
- 正向代理：靠近客户端，代表客户端向服务器发送请求
- 反向代理：靠近服务器端，代表服务器响应客户端的请求

CDN实际上就是一种代理，它代替源站服务器响应客户端的请求，通常扮演着透明代理和反向代理的角色

由于代理在传输过程中插入了一个中间层，所以可以在这个环节做很多有意思的事情，比如：
- 负载均衡：把访问请求均匀分散到多台机器，实现访问集群化
- 内容缓存：暂存上下行的数据，减轻后端的压力
- 安全防护：隐匿 IP, 使用 WAF 等工具抵御网络攻击，保护被代理的机器
- 数据处理：提供压缩、加密等额外的功能


### 常说的`四层`和`七层`到底是什么

- 四层负载均衡
- 七层负载均衡
- 二层转发
- 三层路由

#### TCP/IP 网络分层模型

TCP/IP 协议总共有四层，每一层需要下层的支撑，同时又支撑着上层

- 第一层叫链接层（link layer），负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标记网络上的设备，所以有时候也叫 MAC 层
- 第二层叫网际层（internet layer），IP 协议就处在这一层。因为 IP 协议定义了`IP 地址`的概念，所以就可以在`链接层`的基础上，用 IP 地址取代 MAC 地址，把许许多多的局域网、广域网连接成一个虚拟的巨大网络，在这个网络里找设备时只要把 IP 地址再翻译成 MAC 地址就可以了
- 第三层叫传输层（transport layer），这个层次协议的职责是保证数据在 IP 地址标记的两点之间可靠地传输，是 TCP 协议工作的层次，另外还有它的一个小伙伴UDP
- 协议栈的第四层叫应用层（application layer），由于下面的三层把基础打得非常好，所以在这一层就百花齐放了，有各种面向具体应用的协议。例如 Telnet、SSH、FTP、SMTP 等等，当然还有我们的 HTTP


TCP 是一个有状态的协议，需要先与对方建立连接然后才能发送数据，而且保证数据不丢失不重复。而 UDP 则比较简单，它无状态，不用事先建立连接就可以任意发送数据，但不保证数据一定会发到对方。两个协议的另一个重要区别在于数据的形式。TCP 的数据是连续的字节流，有先后顺序，而 UDP 则是分散的小数据包，是顺序发，乱序收

关于 TCP 和 UDP 可以展开讨论的话题还有很多:
- 三次握手
- 四次挥手

**MAC 层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为数据包**


#### OSI 网络分层模型

